{% load static %}

<!-- Forgot Password Modal -->
<div class="modal-dialog modal-dialog-centered">
  <div class="modal-content">
    <form id="forgotForm">
      <div class="modal-header">
        <h5 class="modal-title">Reset Password</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label for="forgotId" class="form-label">Enter your ID</label>
        <input type="text" id="forgotId" class="form-control" required>
        <!-- The security questions will be inserted here once retrieved -->
        <div id="securityQuestions" class="mt-3 d-none"></div>
        <!-- Error message area for invalid ID or unanswered security questions -->
        <p class="text-danger small mt-2" id="forgotError"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="n btn-outline-light" data-bs-dismiss="modal">Close</button>
        <!-- "Verify" button triggers fetching/displaying security questions -->
        <button type="button" class="n btn-outline-light" id="verifyBtn">Verify</button>
      </div>
    </form>
  </div>
</div>

<!-- New Password Modal -->
<div class="modal-dialog modal-dialog-centered" id="newPasswordModal" style="display:none;">
  <div class="modal-content">
    <form id="newPasswordForm">
      <div class="modal-header">
        <h5 class="modal-title">Set New Password</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="password" id="newPw" class="form-control mb-2" placeholder="New Password" required>
        <input type="password" id="confirmPw" class="form-control" placeholder="Confirm Password" required>
        <!-- Error message area for password validation -->
        <p class="text-danger small mt-2" id="newPwError"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="n btn-outline-light" data-bs-dismiss="modal">Close</button>
        <button type="button" class="n btn-outline-light" id="resetPwBtn">Reset Password</button>
      </div>
    </form>
  </div>
</div>

<!-- Inline CSS to highlight errors -->
<style>
  .error-border {
    border: 2px solid red;
  }
</style>

<!-- Inline JavaScript for basic validation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  var verifyBtn = document.getElementById("verifyBtn");
  var forgotIdInput = document.getElementById("forgotId");
  var forgotError = document.getElementById("forgotError");
  var securityQuestionsDiv = document.getElementById("securityQuestions");

  // Verify button click: validate ID and display security questions
  verifyBtn.addEventListener("click", function() {
    // Clear previous errors
    forgotError.textContent = "";
    forgotIdInput.classList.remove("error-border");

    var idVal = forgotIdInput.value.trim();
    if (!idVal) {
      forgotError.textContent = "Please enter your ID.";
      forgotIdInput.classList.add("error-border");
      return;
    }
    // Simulated ID check: if the ID equals "wrong", mark as invalid.
    if (idVal === "wrong") {
      forgotError.textContent = "The ID entered does not exist.";
      forgotIdInput.classList.add("error-border");
      securityQuestionsDiv.innerHTML = "";
      securityQuestionsDiv.classList.add("d-none");
      return;
    }

    // If valid, display dummy security questions.
    // (Replace this section with your AJAX call to fetch security questions.)
    var questionsHtml = "";
    questionsHtml += '<div class="mb-2">';
    questionsHtml += '  <label class="form-label">What is your favorite color?</label>';
    questionsHtml += '  <input type="text" class="form-control" id="secQ1" placeholder="Your answer" required>';
    questionsHtml += '</div>';
    questionsHtml += '<div class="mb-2">';
    questionsHtml += '  <label class="form-label">What is your pet\'s name?</label>';
    questionsHtml += '  <input type="text" class="form-control" id="secQ2" placeholder="Your answer" required>';
    questionsHtml += '</div>';
    // Button to submit security answers.
    questionsHtml += '<button type="button" class="n btn-outline-light mt-2" id="verifyAnswersBtn">Submit Answers</button>';

    securityQuestionsDiv.innerHTML = questionsHtml;
    securityQuestionsDiv.classList.remove("d-none");
  });

  // Delegate click event for dynamically added "Submit Answers" button.
  document.addEventListener("click", function(e) {
    if (e.target && e.target.id === "verifyAnswersBtn") {
      var secQ1 = document.getElementById("secQ1");
      var secQ2 = document.getElementById("secQ2");
      var allFilled = true;

      // Validate that both answer fields are filled
      if (!secQ1.value.trim()) {
        secQ1.classList.add("error-border");
        allFilled = false;
      } else {
        secQ1.classList.remove("error-border");
      }
      if (!secQ2.value.trim()) {
        secQ2.classList.add("error-border");
        allFilled = false;
      } else {
        secQ2.classList.remove("error-border");
      }
      if (!allFilled) {
        forgotError.textContent = "Please answer all security questions.";
        return;
      }

      // If security questions are answered, show the New Password Modal.
      document.getElementById("newPasswordModal").style.display = "block";
    }
  });

  // Validate new password fields for matching values.
  var resetPwBtn = document.getElementById("resetPwBtn");
  var newPwInput = document.getElementById("newPw");
  var confirmPwInput = document.getElementById("confirmPw");
  var newPwError = document.getElementById("newPwError");

  resetPwBtn.addEventListener("click", function() {
    newPwError.textContent = "";
    newPwInput.classList.remove("error-border");
    confirmPwInput.classList.remove("error-border");

    var newPw = newPwInput.value.trim();
    var confirmPw = confirmPwInput.value.trim();

    if (!newPw || !confirmPw) {
      newPwError.textContent = "Both password fields are required.";
      if (!newPw) newPwInput.classList.add("error-border");
      if (!confirmPw) confirmPwInput.classList.add("error-border");
      return;
    }
    if (newPw !== confirmPw) {
      newPwError.textContent = "Passwords do not match.";
      newPwInput.classList.add("error-border");
      confirmPwInput.classList.add("error-border");
      return;
    }

    // At this point the new passwords match.
    // Proceed with your AJAX call for resetting the password.
    alert("Password has been reset successfully.");
    // Hide the new password modal (you can integrate with your modal library as needed)
    document.getElementById("newPasswordModal").style.display = "none";
  });
});
</script>
